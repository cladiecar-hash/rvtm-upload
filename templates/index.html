<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RVTM INCOSE Analyzer</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='15' fill='%23217346'/><text x='50' y='68' font-size='50' font-weight='bold' text-anchor='middle' fill='white'>X</text><rect x='15' y='20' width='15' height='60' rx='3' fill='%23ffffff33'/><rect x='35' y='20' width='15' height='60' rx='3' fill='%23ffffff33'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .drag-over { border-color: #3b82f6 !important; background-color: #1e3a5f !important; }
        .upload-progress { transition: width 0.3s ease; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">
                <i class="fas fa-file-excel text-green-500 mr-2"></i>
                RVTM INCOSE Analyzer
            </h1>
            <p class="text-gray-400">Upload RVTM Excel file for INCOSE GtWR v4 Gap Analysis</p>
        </div>

        <!-- Upload Card -->
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 mb-6">
            <!-- Drop Zone -->
            <div id="dropZone"
                 class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 transition-colors">
                <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden">

                <div id="uploadPrompt">
                    <i class="fas fa-cloud-upload-alt text-5xl text-gray-500 mb-4"></i>
                    <p class="text-gray-300 text-lg mb-2">Drag & Drop your RVTM Excel file here</p>
                    <p class="text-gray-500 text-sm">or click to browse</p>
                    <p class="text-gray-600 text-xs mt-2">Supported: .xlsx, .xls (max 50MB)</p>
                </div>

                <div id="fileSelected" class="hidden">
                    <i class="fas fa-file-excel text-5xl text-green-500 mb-4"></i>
                    <p id="fileName" class="text-gray-300 text-lg mb-2"></p>
                    <p id="fileSize" class="text-gray-500 text-sm"></p>
                </div>
            </div>

            <!-- Progress Bar (Upload) -->
            <div id="progressContainer" class="hidden mt-4">
                <div class="flex justify-between text-sm text-gray-400 mb-1">
                    <span id="progressLabel">Uploading...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="progressBar" class="upload-progress bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- Processing Status -->
            <div id="processingStatus" class="hidden mt-4">
                <div class="bg-blue-900/30 border border-blue-500 rounded-lg p-4">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-spinner animate-spin text-blue-400 text-2xl mr-3"></i>
                        <div class="flex-1">
                            <p class="text-blue-300 font-medium" id="processingMessage">Processing file...</p>
                            <p class="text-blue-400/70 text-sm" id="processingTime">Elapsed: 0s</p>
                        </div>
                    </div>
                    <!-- Progress Details - Always visible during processing -->
                    <div id="progressDetails">
                        <div class="mb-2">
                            <div class="flex justify-between text-sm text-gray-400 mb-1">
                                <span>Overall Progress</span>
                                <span id="progressPercentText">0%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-3">
                                <div id="dbProgressBar" class="bg-blue-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm mt-3">
                            <div class="bg-gray-800/50 rounded p-2">
                                <span class="text-gray-500">Batch:</span>
                                <span class="text-white ml-1" id="batchProgress">--/--</span>
                            </div>
                            <div class="bg-gray-800/50 rounded p-2">
                                <span class="text-gray-500">Requirements:</span>
                                <span class="text-white ml-1" id="reqProgress">--/--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Button -->
            <button id="uploadBtn"
                    class="w-full mt-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-colors"
                    disabled>
                <i class="fas fa-paper-plane mr-2"></i>
                Send to n8n for Analysis
            </button>
        </div>

        <!-- Result Card -->
        <div id="resultCard" class="hidden bg-gray-800 rounded-xl shadow-2xl p-6">
            <h2 class="text-xl font-semibold text-white mb-4">
                <i class="fas fa-chart-bar mr-2"></i>
                Analysis Result
            </h2>

            <div id="resultSuccess" class="hidden">
                <div class="bg-green-900/30 border border-green-500 rounded-lg p-4 mb-4">
                    <p class="text-green-400 font-medium">
                        <i class="fas fa-check-circle mr-2"></i>
                        File processed successfully!
                    </p>
                </div>
                <div id="statsGrid" class="grid grid-cols-2 gap-4"></div>

                <!-- Download Button -->
                <div id="downloadSection" class="hidden mt-4">
                    <a id="downloadBtn" href="#"
                       class="inline-flex items-center justify-center w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                        <i class="fas fa-file-download mr-2"></i>
                        <span id="downloadFileName">Download Results</span>
                    </a>
                </div>
            </div>

            <div id="resultError" class="hidden">
                <div class="bg-red-900/30 border border-red-500 rounded-lg p-4">
                    <p class="text-red-400 font-medium">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span id="errorMessage">An error occurred</span>
                    </p>
                </div>
            </div>

            <div id="rawResponse" class="mt-4">
                <details class="text-gray-400">
                    <summary class="cursor-pointer text-sm hover:text-gray-300">View raw response</summary>
                    <pre id="rawResponseContent" class="mt-2 bg-gray-900 p-3 rounded text-xs overflow-x-auto"></pre>
                </details>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-8 text-gray-500 text-sm">
            <p>INCOSE GtWR v4 (INCOSE-TP-2010-006-04) Compliance Analysis</p>
            <p class="mt-1">Powered by n8n workflow automation</p>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const fileSelected = document.getElementById('fileSelected');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const progressLabel = document.getElementById('progressLabel');
        const processingStatus = document.getElementById('processingStatus');
        const processingMessage = document.getElementById('processingMessage');
        const processingTime = document.getElementById('processingTime');
        const resultCard = document.getElementById('resultCard');

        let selectedFile = null;
        let currentJobId = null;
        let pollingInterval = null;
        let progressPollingInterval = null;
        let startTime = null;
        let lastUpdatedAt = null;
        let lastChangeTime = null;
        const STALE_TIMEOUT_MS = 3 * 60 * 1000; // 3 minutes timeout
        const PROGRESS_POLL_INTERVAL = 10000; // 10 seconds

        // Click to browse
        dropZone.addEventListener('click', () => fileInput.click());

        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Drag and drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        function handleFile(file) {
            const validExtensions = ['.xlsx', '.xls'];
            const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();

            if (!validExtensions.includes(fileExt)) {
                alert('Please select a valid Excel file (.xlsx or .xls)');
                return;
            }

            selectedFile = file;
            uploadPrompt.classList.add('hidden');
            fileSelected.classList.remove('hidden');
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            uploadBtn.disabled = false;
            resultCard.classList.add('hidden');
            processingStatus.classList.add('hidden');
            document.getElementById('downloadSection').classList.add('hidden');
            // Reset progress UI
            resetProgressUI();
        }

        function resetProgressUI() {
            document.getElementById('dbProgressBar').style.width = '0%';
            document.getElementById('progressPercentText').textContent = '0%';
            document.getElementById('batchProgress').textContent = '--/--';
            document.getElementById('reqProgress').textContent = '--/--';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatElapsedTime(seconds) {
            if (seconds < 60) return `${seconds}s`;
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}m ${secs}s`;
        }

        // Upload
        uploadBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            uploadBtn.disabled = true;
            progressContainer.classList.remove('hidden');
            processingStatus.classList.add('hidden');
            resultCard.classList.add('hidden');
            progressLabel.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percent + '%';
                        progressPercent.textContent = percent + '%';
                    }
                });

                xhr.onload = function() {
                    let response;
                    try {
                        response = JSON.parse(xhr.responseText);
                    } catch {
                        response = { raw: xhr.responseText };
                    }

                    // Check if we got a job_id (async processing)
                    if (xhr.status === 202 && response.job_id) {
                        currentJobId = response.job_id;
                        progressContainer.classList.add('hidden');
                        processingStatus.classList.remove('hidden');
                        processingMessage.textContent = response.message || 'Processing file...';
                        startTime = Date.now();
                        startPolling();
                    } else if (xhr.status === 200 && response.status === 'success') {
                        // Immediate response (small file)
                        progressContainer.classList.add('hidden');
                        resultCard.classList.remove('hidden');
                        showSuccess(response);
                        uploadBtn.disabled = false;
                    } else {
                        progressContainer.classList.add('hidden');
                        resultCard.classList.remove('hidden');
                        showError(response.message || 'Upload failed');
                        uploadBtn.disabled = false;
                    }
                };

                xhr.onerror = function() {
                    progressContainer.classList.add('hidden');
                    resultCard.classList.remove('hidden');
                    showError('Network error occurred');
                    uploadBtn.disabled = false;
                };

                xhr.open('POST', '/upload');
                xhr.send(formData);

            } catch (error) {
                progressContainer.classList.add('hidden');
                showError(error.message);
                uploadBtn.disabled = false;
            }
        });

        function startPolling() {
            lastChangeTime = Date.now();
            lastUpdatedAt = null;

            // Update elapsed time every second
            const timeInterval = setInterval(() => {
                if (!startTime) {
                    clearInterval(timeInterval);
                    return;
                }
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                processingTime.textContent = `Elapsed: ${formatElapsedTime(elapsed)}`;

                // Check for stale timeout
                if (lastChangeTime && (Date.now() - lastChangeTime) > STALE_TIMEOUT_MS) {
                    stopPolling();
                    clearInterval(timeInterval);
                    processingStatus.classList.add('hidden');
                    resultCard.classList.remove('hidden');
                    showError('Processing timeout: No progress updates for 3 minutes. The job may have stalled.');
                    uploadBtn.disabled = false;
                }
            }, 1000);

            // Poll app status every 3 seconds (for completion/callback)
            pollingInterval = setInterval(async () => {
                if (!currentJobId) {
                    stopPolling();
                    clearInterval(timeInterval);
                    return;
                }

                try {
                    const response = await fetch(`/status/${currentJobId}`);
                    const data = await response.json();

                    if (data.status === 'completed') {
                        stopPolling();
                        clearInterval(timeInterval);
                        processingStatus.classList.add('hidden');
                        resultCard.classList.remove('hidden');

                        if (data.result) {
                            document.getElementById('rawResponseContent').textContent =
                                JSON.stringify(data.result, null, 2);
                            showSuccessFromResult(data.result);
                        } else {
                            showSuccess({ message: 'Processing completed' });
                        }

                        // Show download button if file available
                        if (data.download_url) {
                            const downloadSection = document.getElementById('downloadSection');
                            const downloadBtn = document.getElementById('downloadBtn');
                            const downloadFileName = document.getElementById('downloadFileName');
                            downloadSection.classList.remove('hidden');
                            downloadBtn.href = data.download_url;
                            downloadFileName.textContent = `Download ${data.file_name || 'Results'}`;
                        }

                        uploadBtn.disabled = false;
                    } else if (data.status === 'error') {
                        stopPolling();
                        clearInterval(timeInterval);
                        processingStatus.classList.add('hidden');
                        resultCard.classList.remove('hidden');
                        showError(data.message || 'Processing failed');
                        uploadBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Status polling error:', error);
                }
            }, 3000);

            // Poll Supabase progress every 10 seconds
            progressPollingInterval = setInterval(async () => {
                if (!currentJobId) return;

                try {
                    const response = await fetch(`/api/progress/${currentJobId}`);
                    const data = await response.json();

                    if (data.status === 'not_found') {
                        // Job not yet in DB, keep waiting
                        return;
                    }

                    // Check if data has changed
                    if (data.updated_at && data.updated_at !== lastUpdatedAt) {
                        lastUpdatedAt = data.updated_at;
                        lastChangeTime = Date.now();
                    }

                    // Update progress UI
                    updateProgressUI(data);

                    // Handle completion or error from DB
                    if (data.status === 'completed') {
                        // Let the /status endpoint handle the final result
                        processingMessage.textContent = 'Analysis complete, fetching results...';
                    } else if (data.status === 'error') {
                        stopPolling();
                        clearInterval(timeInterval);
                        processingStatus.classList.add('hidden');
                        resultCard.classList.remove('hidden');
                        showError(data.error_message || 'Processing failed');
                        uploadBtn.disabled = false;
                    }

                } catch (error) {
                    console.error('Progress polling error:', error);
                }
            }, PROGRESS_POLL_INTERVAL);
        }

        function updateProgressUI(data) {
            const dbProgressBar = document.getElementById('dbProgressBar');
            const progressPercentText = document.getElementById('progressPercentText');
            const batchProgress = document.getElementById('batchProgress');
            const reqProgress = document.getElementById('reqProgress');

            // Update percentage bar
            const percent = data.percent_complete || 0;
            dbProgressBar.style.width = `${percent}%`;
            progressPercentText.textContent = `${percent}%`;

            // Update batch progress
            const currentBatch = data.current_batch || 0;
            const totalBatches = data.total_batches || 0;
            batchProgress.textContent = totalBatches > 0 ? `${currentBatch}/${totalBatches}` : '--/--';

            // Update requirements progress
            const processedReq = data.processed_requirements || 0;
            const totalReq = data.total_requirements || 0;
            reqProgress.textContent = totalReq > 0 ? `${processedReq}/${totalReq}` : '--/--';

            // Update message based on status
            if (data.status === 'processing' && totalBatches > 0) {
                processingMessage.textContent = `Analyzing batch ${currentBatch} of ${totalBatches}...`;
            } else if (data.status === 'pending') {
                processingMessage.textContent = 'Waiting for n8n to start processing...';
            }
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            if (progressPollingInterval) {
                clearInterval(progressPollingInterval);
                progressPollingInterval = null;
            }
            currentJobId = null;
            startTime = null;
            lastUpdatedAt = null;
            lastChangeTime = null;
        }

        function showSuccessFromResult(result) {
            document.getElementById('resultSuccess').classList.remove('hidden');
            document.getElementById('resultError').classList.add('hidden');

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';

            // Handle different response formats
            const stats = result.stats || result.n8n_response?.stats || result;

            if (stats) {
                const statItems = [
                    { label: 'Total Rows', value: stats.total_rows?.toLocaleString() || 'N/A', icon: 'fa-table' },
                    { label: 'Unique L1 Requirements', value: stats.unique_L1_requirements?.toLocaleString() || 'N/A', icon: 'fa-list' },
                    { label: 'Columns Found', value: stats.columns_found || 'N/A', icon: 'fa-columns' },
                ];

                statItems.forEach(stat => {
                    if (stat.value !== 'N/A') {
                        statsGrid.innerHTML += `
                            <div class="bg-gray-700 rounded-lg p-4">
                                <div class="flex items-center">
                                    <i class="fas ${stat.icon} text-blue-400 mr-3"></i>
                                    <div>
                                        <p class="text-gray-400 text-sm">${stat.label}</p>
                                        <p class="text-white text-xl font-semibold">${stat.value}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
            }
        }

        function showSuccess(response) {
            document.getElementById('resultSuccess').classList.remove('hidden');
            document.getElementById('resultError').classList.add('hidden');
            document.getElementById('rawResponseContent').textContent =
                JSON.stringify(response, null, 2);

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';

            const n8nData = response.n8n_response;
            if (n8nData && n8nData.stats) {
                const stats = n8nData.stats;
                const statItems = [
                    { label: 'Total Rows', value: stats.total_rows?.toLocaleString() || 'N/A', icon: 'fa-table' },
                    { label: 'Unique L1 Requirements', value: stats.unique_L1_requirements?.toLocaleString() || 'N/A', icon: 'fa-list' },
                    { label: 'Columns Found', value: stats.columns_found || 'N/A', icon: 'fa-columns' },
                ];

                statItems.forEach(stat => {
                    statsGrid.innerHTML += `
                        <div class="bg-gray-700 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas ${stat.icon} text-blue-400 mr-3"></i>
                                <div>
                                    <p class="text-gray-400 text-sm">${stat.label}</p>
                                    <p class="text-white text-xl font-semibold">${stat.value}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
        }

        function showError(message) {
            document.getElementById('resultSuccess').classList.add('hidden');
            document.getElementById('resultError').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
    </script>
</body>
</html>
